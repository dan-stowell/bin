#!/usr/bin/env bash

MODEL="openrouter/mistralai/devstral-small"

if git diff --quiet && git diff --cached --quiet; then
  echo "No changes to stash"
  exit 0
fi

git add -A

DIFF=$(git diff --cached)

STASH_MSG=$(echo "$DIFF" | llm --model "$MODEL" --system "Generate a concise stash message for this git diff. Return only the stash message itself, nothing else.")

STASH_MSG="${STASH_MSG#\"}"
STASH_MSG="${STASH_MSG%\"}"

if [ $? -ne 0 ] || [ -z "$STASH_MSG" ]; then
  echo "Error: Failed to generate stash message"
  exit 1
fi

git stash -m "$STASH_MSG"
